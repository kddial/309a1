<!DOCTYPE html>
<html>
<head>
  <title>CSC309 Assignment 1</title>
	<script src="http://code.jquery.com/jquery-1.9.1.min.js" type="text/javascript"></script>
	<link type="text/css" href="index.css" rel="stylesheet"> </link>
	<script type="text/javascript">


	function toggleMe(a){
		var e=document.getElementById(a);
		if(!e)return true;
		if(e.style.display=="block"){
			e.style.display="none"
		}
		else{
			e.style.display="block"
		}
		return true;
	}

	function topicsort(a, b){
		var firstelement = parseFloat($(a).children(".topic_header").children(".topic_votes").text());
		var secondelement = parseFloat($(b).children(".topic_header").children(".topic_votes").text());
		return (firstelement < secondelement) ? 1 : (firstelement > secondelement) ? -1 : 0;
	}

	function replysort(a, b){
		var firstelement = parseFloat($(a).children(".reply_votes").text());
		var secondelement = parseFloat($(b).children(".reply_votes").text());
		return (firstelement < secondelement) ? 1 : (firstelement > secondelement) ? -1 : 0;
	}
	
	function sendstuff(ti, lk) {
		$.ajax({
			type: "POST",
			url: "/post",
			data: {"topic": ti, "vote": 0, "link": lk, "replies": "[]"},
			dataType: "json"
			});
		return true;
		 }
		 
	function getstuff() {
		$.get("/get",
		function(data) {
			// Loop through all the topics
			for (var i=0;i<data.topics.length;i++)
			{
				$('.topicarea').append("<p>" + "topic name:" + data.topics[i].topic + " topic vote: " + data.topics[i].vote 
											+ " topic replies: " + data.topics[i].replies + "</p>");

			}
		});
		return true;
	}

	function loadHTML() {
		$.get("/get",
		function(data) {

			var output;
			// Clear all the contents inside topic 
			$('.topicarea').html("");

			// Loop through all the topics and append the HTML tags to output
			for (var i=0;i<data.topics.length;i++)
			{
				output = 		'<div class="topic">' +
									'<div class="topic_header">' +
										'<div class="vote">^</div>' +
										'<div class="topic_votes">' + data.topics[i].vote + '</div>' +
										'<div class="topictitle"> &nbsp;' + data.topics[i].topic + 
										'</div>' +
									'</div>' +
									'&nbsp;&nbsp; <a class="view_comments"> View comments</a> &nbsp;&nbsp;' +
									'<a class="replylink">Reply</a>&nbsp;&nbsp;' +
									'<a class="link" href="' + data.topics[i].link + '">Link</a>' +
									'<p class="replyview">' +
										'<textarea cols="80" rows="5"></textarea>' +
										'<br>' +
										'<a class="submitlink">Submit</a>' +
									'</p>' +
									'<div class="replies"> ADD REPLIES HERE LATER </div>' +
								'</div>';

				$('.topicarea').append(output);
			}
		});
		return true;
	}

	function cheat() {
		$.ajax({
			type: "POST",
			url: "/cheat",
			data: $('html').html(),
			dataType: "html"
		});
		return true;
	}

	</script>
</head>

</body>
<div class="topicarea">
</div>

<div class="newtopic">
	<button type="button" class="newtopicbutton">New Topic</button>
	<p class="topicview">
		<textarea class="topictext" rows="5" cols="80"></textarea><br>
		<textarea class="topiclink" rows="1" cols="80"></textarea><br>
		<a class="submittopic">Submit Topic</a>
	</p>
</div>

<script language="javascript" type="text/javascript">

$(document).ready(function(){

	// Load the HTML from server
	loadHTML();

	var reply_html_begin =	
					'<div class="reply">' + 
						'<p class="parent"></p>' +
							'<div class="vote">^</div>' +
							'<div class="reply_votes">0</div>';

	var reply_html_end =			
							'&nbsp;&nbsp;<a class="replylink">Reply</a>' +
							'<p class="replyview" style="display:none;">' +
								'<textarea rows="5" cols="80"></textarea><br>' +
								'<a class="submitlink">Submit</a>' +
							'</p>' +
						'<div class="replies">' +
						'</div>' + 
					'</div>';

	var topic_html_begin =  
					'<div class="topic">' +
						'<div class="topic_header">' +
							'<div class="vote">^</div>' +
							'<div class="topic_votes">0</div>' +
							'<div class="topictitle"> &nbsp;'

	var topic_html_middle =			
							'</div>' +
						'</div>' +
						'&nbsp;&nbsp; <a class="view_comments"> View comments</a> &nbsp;&nbsp;' +
						'<a class="replylink">Reply</a>&nbsp;&nbsp;' +
						'<a class="link" href="'

	var topic_html_end = '">Link</a>' +
						'<p class="replyview">' +
							'<textarea cols="80" rows="5"></textarea>' +
							'<br>' +
							'<a class="submitlink">Submit</a>' +
						'</p>' +
						'<div class="replies"> </div>' +
					'</div>';

	// Clicking on the submit reply link
	$(document).on("click", ".submitlink", function() {
		var output = $(this).parent().find("textarea").val(); // The text inside the textarea
		$(this).parent().find("textarea").val("");  // Clear the text inside the textarea
		$(this).parent().parent().children(".replies").append(reply_html_begin + output + reply_html_end);
		$(this).parent().toggle();  // Toggle the replyview to disapeer after hitting submit
									// should do error checking to make sure text isnt empty
		$(this).parent().parent().parent().siblings(".replies").toggle();	// Display comments
		cheat();
	});

	// Clicking on view_comments
	$(document).on("click", ".view_comments", function () {
		$(this).siblings(".replies").toggle();
	});

	// Clicking on Reply link
	$(document).on("click", ".replylink", function() {
		// Clicking on Reply link
		$(this).siblings(".replyview").toggle();
	});

	// New topic button
	$(document).on("click", ".newtopicbutton", function() {
		$(this).siblings(".topicview").toggle();
	});

	// Submitting a new topic by clicking on submit link
	$(document).on("click", ".submittopic", function() {
		var output = $(this).siblings(".topictext").val();
		var tlink = $(this).siblings(".topiclink").val();
		$(this).siblings(".topictext").val("");
		$(this).siblings(".topiclink").val("");
		$(this).siblings(".topicview").toggle();
		//$(".topicarea").append(topic_html_begin + output + topic_html_middle + tlink + topic_html_end);
		$(this).parent().toggle();
		sendstuff(output, tlink);
		loadHTML();
		cheat();
	});

	// Sort on every vote clicked
	$(document).on("click", ".vote",  function () {
		// If topic vote button, this does nothing, otherwise, increment the vote for this reply.
		var replynum = parseFloat($(this).siblings(".reply_votes").text()) + 1;
		$(this).siblings(".reply_votes").text(replynum);

		// Increment the vote for the topic regardless of which vote button.
		var topicnum = parseFloat($(this).closest(".topic").children(".topic_header").children(".topic_votes").text()) + 1;
		$(this).closest(".topic").children(".topic_header").children(".topic_votes").text(topicnum);

		// Sort the topics as there is a change in the number of votes.
		var topiclist = $(".topic").get();
		topiclist.sort(topicsort);
		$.each(topiclist, function(x, y) {$(".topicarea").append(y)});

		// Sort the reply and its siblings.
		var replylist = $(this).closest(".replies").children(".reply").get();
		replylist.sort(replysort);
		$.each(replylist, function(x, y) {$(this).closest(".replies").append(y)});
		
		cheat();
	});

});

</script>

</body>
</html>
